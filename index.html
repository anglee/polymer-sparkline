<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Sparkline</title>
  <script src="bower_components/lodash/dist/lodash.js"></script>
  <script src="bower_components/platform/platform.js"></script>
  <script src="bower_components/polymer/polymer.js"></script>
  <script src="p5-complete-0.3.6/p5.js"></script>
  <script>



    var getSparkline = function(numbers, container, mouse) {
      var w = 200;
      var h = 50;
      var circleSize = 10;
      var sketch = function (s) {
        s.setup = function () {
          s.createCanvas(w, h, false, container);
          //s.noLoop(0);
          window.sketch = s;
        };

        s.draw = function () {
          s.clear();
          // calculate min, max, sum, avg
          var min = Number.POSITIVE_INFINITY;
          var mini = null;
          var max = Number.NEGATIVE_INFINITY;
          var maxi = null;
          var sum = 0;
          _.each(numbers, function(num, i) {
            if (num > max) {
              max = num;
              maxi = i;
            }
            if (num < min) {
              min = num;
              mini = i;
            }
            sum += num;
          });
          var avg = sum / numbers.length;

          //


          var xstep = (w - circleSize * 2) / (numbers.length - 1);
          var yScale = (h - circleSize) / (max - min);
          // draw line
//          for (var i = 0; i < numbers.length - 1; ++i) {
//            s.line(xstep * i, h - numbers[i] * yScale, xstep * (i+1), h - numbers[i+1] * yScale);
//          }

          var tranY = function(yIn) {
            return h - (yIn - min) * yScale;
          };
          var transX = function(xIn) {
            return circleSize + xIn * xstep;
          };

          // draw area
          s.noStroke();
          s.fill(0, 154, 166, 128);
          s.beginShape();
          s.vertex(transX(0), h);
          for (var i = 0; i < numbers.length; ++i) {
            s.vertex(transX(i), tranY(numbers[i]));
          }
          s.vertex(transX(numbers.length - 1), h);
          s.endShape(s.CLOSE);



          // mark avg
          s.stroke(0);
          s.line(transX(0), tranY(avg), transX(numbers.length - 1), tranY(avg));

          // mark max
          s.noStroke();
          s.fill(255, 0, 0, 128);
          s.ellipse(transX(maxi), tranY(max), circleSize, circleSize);

          // mark min
          s.noStroke();
          s.fill(0, 0, 255, 128);
          s.ellipse(transX(mini), tranY(min), circleSize, circleSize);

          mouse.x = s.mouseX;
          mouse.y = s.mouseY;

          if (s.mouseX >= transX(0) && s.mouseX <= transX(numbers.length - 1) &&
              s.mouseY >= 0 && s.mouseY <= h) {
            s.stroke(255, 0, 0);
            s.line(s.mouseX, 0, s.mouseX, h);
          }
        };

        s.container = container;
      };
      var myp5 = new p5(sketch, container);
    };

  </script>
</head>
<body>

<polymer-element name="my-sparkline" attributes="numbers mouse">
  <template>
    <div id="p5-spark"></div>
  </template>
  <script>
    Polymer({
      ready: function() {

        if (!this.mouse) {
          this.mouse = {};
        }

        if (typeof this.numbers === 'string') {
          console.warn("parsing numbers from string");
          this.numbers = JSON.parse(this.numbers);
        }
        getSparkline(this.numbers, this.$["p5-spark"], this.mouse);
      }
    });
  </script>
</polymer-element>

<polymer-element name="init-foo" attributes="foo mouse">
  <script>
    Polymer('init-foo', {
      ready: function() {
        this.foo = [
          [1,2,4,8,4,2,1],
          [1,2,1,2,1,5],
          [7, 9, 8, 5, 4, 1]
        ];
      }
    });
  </script>
</polymer-element>

<polymer-element name="my-app">
  <template>
    <init-foo foo="{{foo}}"></init-foo>
    <my-sparkline counter="10" numbers="{{foo[0]}}" mouse="{{mouse1}}"></my-sparkline>
    <div><b>{{mouse1.x}}, {{mouse1.y}}</b></div>
    <my-sparkline counter="10" numbers="{{foo[1]}}" mouse="{{mouse2}}"></my-sparkline>
    <div><b>{{mouse2.x}}, {{mouse2.y}}</b></div>
    <my-sparkline counter="10" numbers="{{foo[2]}}" mouse="{{mouse3}}"></my-sparkline>
    <div><b>{{mouse3.x}}, {{mouse3.y}}</b></div>
  </template>
  <script>
    Polymer('my-app', {
      ready: function() {
        console.log("my-app ready");
        console.log("foo = ", this.foo);
        console.log("mouse", this.mouse);
      }
    });
  </script>
</polymer-element>



<my-app >Points</my-app>


</body>
</html>